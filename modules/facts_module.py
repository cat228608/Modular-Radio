# /opt/radio/modules/facts_module.py

import random
import requests
from .base_module import RadioModule
from logger import log

# –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –µ—Å–ª–∏ –∫–æ–Ω—Ñ–∏–≥ –ø—É—Å—Ç–æ–π
DEFAULT_BACKUP_FACTS = [
    "–ó–Ω–∞–µ—Ç–µ –ª–∏ –≤—ã, —á—Ç–æ –º—É–∑—ã–∫–∞, —Å–æ–∑–¥–∞–Ω–Ω–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏, —É–∂–µ –ø—Ä–æ–¥–∞–µ—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö?",
    "–ö—Å—Ç–∞—Ç–∏, —Å–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è –ø–µ—Å–Ω—è –≤ –º–∏—Ä–µ –¥–ª–∏—Ç—Å—è 1000 –ª–µ—Ç.",
    "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —Ñ–æ–Ω–æ–≤–∞—è –º—É–∑—ã–∫–∞ –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫.",
    "–ü–µ—Ä–≤–∞—è –ø–µ—Å–Ω—è –≤ –∫–æ—Å–º–æ—Å–µ –±—ã–ª–∞ —Å—ã–≥—Ä–∞–Ω–∞ –Ω–∞ –≥—É–±–Ω–æ–π –≥–∞—Ä–º–æ—à–∫–µ –≤ 1965 –≥–æ–¥—É.",
    "–ù–∏–∫—Ç–æ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç, –ø–æ—á–µ–º—É –æ–¥–Ω–∞ –ø–µ—Å–Ω—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ö–∏—Ç–æ–º, –∞ –¥—Ä—É–≥–∞—è –Ω–µ—Ç.",
    "–¢–µ—Ä–º–∏–Ω '–¥–∏—Å–∫-–∂–æ–∫–µ–π' –±—ã–ª –ø—Ä–∏–¥—É–º–∞–Ω –≤ 1935 –≥–æ–¥—É.",
    "–ü–µ—Ä–≤–∞—è –ø–ª–∞—Ç–Ω–∞—è —Ä–∞–¥–∏–æ—Ä–µ–∫–ª–∞–º–∞ –≤—ã—à–ª–∞ –≤ —ç—Ñ–∏—Ä –≤ 1922 –≥–æ–¥—É.",
    "–í–∏–Ω–∏–ª —Å–Ω–æ–≤–∞ –≤ –º–æ–¥–µ: –ø—Ä–æ–¥–∞–∂–∏ –ø–ª–∞—Å—Ç–∏–Ω–æ–∫ —Ä–∞—Å—Ç—É—Ç –∫–∞–∂–¥—ã–π –≥–æ–¥.",
    "–°–∞–º—ã–π –¥–æ—Ä–æ–≥–æ–π –∫–ª–∏–ø –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–æ–∏–ª 7 –º–∏–ª–ª–∏–æ–Ω–æ–≤ –¥–æ–ª–ª–∞—Ä–æ–≤ (Michael Jackson - Scream).",
    "–í–∞—à–µ —Å–µ—Ä–¥—Ü–µ–±–∏–µ–Ω–∏–µ —á–∞—Å—Ç–æ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —Ä–∏—Ç–º –º—É–∑—ã–∫–∏, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Å–ª—É—à–∞–µ—Ç–µ."
]

DEFAULT_FACTS_STR = "\n".join(DEFAULT_BACKUP_FACTS)

class FactsModule(RadioModule):
    def __init__(self):
        super().__init__()
        # –ü–æ–º–µ—á–∞–µ–º –º–æ–¥—É–ª—å –∫–∞–∫ —Å–∏—Å—Ç–µ–º–Ω—ã–π, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –ª–µ–∑ –≤ –ø–∞–ª–∏—Ç—Ä—É —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è,
        # –Ω–æ –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        self.is_system = True

    def get_config_schema(self):
        return {
            "api_url": {
                "label": "URL –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤ (JSON {fact: {text: ...}})",
                "type": "text",
                "default": "https://randstuff.ru/fact/generate/"
            },
            "backup_facts": {
                "label": "–ó–∞–ø–∞—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ - –æ–¥–∏–Ω —Ñ–∞–∫—Ç)",
                "type": "textarea",
                "default": DEFAULT_FACTS_STR
            }
        }

    def prepare(self, event_config, context):
        # –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —ç—Ñ–∏—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
        return None

    def get_random_fact(self):
        """–ü—É–±–ª–∏—á–Ω—ã–π –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏."""
        
        # 1. –ü—Ä–æ–±—É–µ–º –≤–∑—è—Ç—å –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
        api_url = self.config.get("api_url", "https://randstuff.ru/fact/generate/")
        if api_url:
            try:
                headers = {'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest'}
                response = requests.post(api_url, headers=headers, timeout=2)
                if response.status_code == 200:
                    data = response.json()
                    # –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ randstuff.ru, –º–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å –¥–ª—è –¥—Ä—É–≥–∏—Ö API
                    if 'fact' in data and 'text' in data['fact']:
                        text = data['fact']['text']
                        if len(text) < 250: # –ù–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ
                            log("üí° [FactsModule] –§–∞–∫—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ —Å–µ—Ç–∏.")
                            return text
            except Exception as e:
                pass # –ú–æ–ª—á–∞ –ø–∞–¥–∞–µ–º –≤ –±—ç–∫–∞–ø

        # 2. –ï—Å–ª–∏ —Å–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –±–µ—Ä–µ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (–±—ç–∫–∞–ø)
        raw_backups = self.config.get("backup_facts", DEFAULT_FACTS_STR)
        backup_list = [line.strip() for line in raw_backups.split('\n') if line.strip()]
        
        if backup_list:
            log("üíæ [FactsModule] –§–∞–∫—Ç –≤–∑—è—Ç –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã.")
            return random.choice(backup_list)
        
        return "–ú—É–∑—ã–∫–∞ –≤–µ—á–Ω–∞, –∞ —Ñ–∞–∫—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å."